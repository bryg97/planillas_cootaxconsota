<?php
// diagnostico.php
session_start();
include __DIR__ . '/../../config_planillas/config.php';

if(!isset($_SESSION['rol']) || $_SESSION['rol'] !== 'admin'){
    header("Location: login.php");
    exit();
}

$mensaje = $_GET['m'] ?? '';
?>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>üß† Supervisor IA - Diagn√≥stico</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:#fff; padding:20px;}
.card{border-radius:10px; box-shadow:0 3px 12px rgba(0,0,0,0.08);}
pre{white-space:pre-wrap; word-wrap:break-word;}
.small-muted{font-size:0.9rem; color:#666;}
.result-ok{color:green;}
.result-warn{color:orange;}
.result-err{color:red;}
footer img{position:fixed; right:20px; bottom:12px; width:120px; opacity:0.9;}
</style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>üß† Supervisor IA ‚Äî Diagn√≥stico del Sistema</h3>
    <a href="panel.php" class="btn btn-secondary">‚¨Ö Volver al Panel</a>
  </div>

  <?php if($mensaje): ?>
    <div class="alert alert-info"><?= htmlspecialchars($mensaje) ?></div>
  <?php endif; ?>

  <div class="card p-3 mb-3">
    <p class="small-muted">Este m√≥dulo escanea los archivos PHP dentro de la carpeta <code>/planillas/</code>, aplica correcciones seguras, crea backups y guarda un registro en la base de datos. Solo admin puede ejecutar.</p>
    <form method="post" action="analizar.php">
      <div class="mb-2">
        <label class="form-label">Opciones de ejecuci√≥n</label>
        <select name="modo" class="form-select">
          <option value="analizar">Analizar (solo informe)</option>
          <option value="auto_fix">Analizar y aplicar correcciones autom√°ticas (recomendado)</option>
        </select>
      </div>
      <button class="btn btn-success" type="submit">üîé Ejecutar diagn√≥stico</button>
    </form>
  </div>

  <div id="resultados" class="card p-3">
    <h5>√öltimos resultados</h5>
    <p class="small-muted">Puedes ver el historial en la tabla <code>supervisor_logs</code> o abrir un archivo para ver/editar.</p>

    <div class="mb-3">
      <a href="ver_archivo.php?file=diagnostico.php" class="btn btn-outline-primary btn-sm">Ver archivo: diagnostico.php</a>
      <a href="ver_archivo.php?file=analizar.php" class="btn btn-outline-primary btn-sm">Ver archivo: analizar.php</a>
      <a href="ver_archivo.php?file=ver_archivo.php" class="btn btn-outline-primary btn-sm">Ver archivo: ver_archivo.php</a>
      <a href="ver_archivo.php?file=guardar_archivo.php" class="btn btn-outline-primary btn-sm">Ver archivo: guardar_archivo.php</a>
    </div>

    <div class="mt-2">
      <h6>Historial reciente (√∫ltimos 20 registros)</h6>
      <?php
      $stmt = $conn->prepare("SELECT fecha, archivo, tipo, descripcion, accion_realizada, usuario FROM supervisor_logs ORDER BY fecha DESC LIMIT 20");
      $stmt->execute();
      $res = $stmt->get_result();
      if($res->num_rows > 0){
        echo '<table class="table table-sm table-striped"><thead><tr><th>Fecha</th><th>Archivo</th><th>Tipo</th><th>Acci√≥n</th><th>Usuario</th></tr></thead><tbody>';
        while($r = $res->fetch_assoc()){
          $cls = $r['tipo']=='fix' ? 'result-ok' : ($r['tipo']=='warning' ? 'result-warn' : 'result-err');
          echo '<tr><td>'.$r['fecha'].'</td><td>'.htmlspecialchars($r['archivo']).'</td><td class="'.$cls.'">'.htmlspecialchars($r['tipo']).'</td><td>'.htmlspecialchars($r['accion_realizada']).'</td><td>'.htmlspecialchars($r['usuario']).'</td></tr>';
        }
        echo '</tbody></table>';
      } else {
        echo '<div class="alert alert-secondary">No hay registros todav√≠a.</div>';
      }
      ?>
    </div>
  </div>

</div>

<footer>
  <img src="https://cootaxconsota.com/wp-content/uploads/2024/07/logo-empresa-png2-1.png" alt="logo">
</footer>
</body>
</html>
